<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQL Query Validator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }
      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }
      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }
      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        resize: vertical;
        min-height: 150px;
        margin-bottom: 15px;
      }
      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        margin: 5px;
        transition: all 0.3s;
      }
      .btn:hover {
        transform: translateY(-2px);
      }
      .btn-primary {
        background: #2563eb;
        color: white;
      }
      .btn-secondary {
        background: #7c3aed;
        color: white;
      }
      .btn-outline {
        background: transparent;
        border: 2px solid #ddd;
        color: #333;
      }
      .status-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
      }
      .valid {
        background: #d1fae5;
        color: #059669;
      }
      .invalid {
        background: #fee2e2;
        color: #dc2626;
      }
      .hidden {
        display: none;
      }
      .error {
        background: #fef2f2;
        color: #dc2626;
        padding: 10px;
        border-radius: 5px;
        margin: 5px 0;
        border-left: 4px solid #dc2626;
      }
      .warning {
        background: #fffbeb;
        color: #d97706;
        padding: 10px;
        border-radius: 5px;
        margin: 5px 0;
        border-left: 4px solid #d97706;
      }
      .example-card {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        cursor: pointer;
        border: 2px solid #e2e8f0;
        transition: all 0.3s;
      }
      .example-card:hover {
        border-color: #2563eb;
        transform: translateY(-2px);
      }
      .example-card code {
        background: #e2e8f0;
        padding: 5px;
        border-radius: 4px;
        font-family: monospace;
        display: block;
        margin-top: 5px;
      }
      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üöÄ SQL Query Validator</h1>
        <p>Validasi query SQL dengan deteksi WHERE dalam komentar</p>
      </div>

      <div class="main-content">
        <!-- Input Section -->
        <div class="card">
          <h3>üìù Masukkan Query SQL:</h3>
          <textarea
            id="sqlQuery"
            placeholder="Contoh: UPDATE users SET name = 'John' // where id = 1"></textarea>

          <div class="checkbox-label">
            <input type="checkbox" id="strictMode" checked />
            <label for="strictMode"
              >üîí Strict Mode (Error untuk WHERE dalam komentar)</label
            >
          </div>

          <div>
            <button class="btn btn-primary" onclick="validateQuery()">
              ‚úÖ Validasi Query
            </button>
            <button class="btn btn-secondary" onclick="autoFixQuery()">
              üîß Auto Fix
            </button>
            <button class="btn btn-outline" onclick="clearAll()">
              üóëÔ∏è Clear
            </button>
          </div>
        </div>

        <!-- Results Section -->
        <div class="card">
          <div id="result">
            <h3>üìä Hasil Validasi</h3>
            <p>Masukkan query SQL dan klik "Validasi Query"</p>

            <div id="validationResult" class="hidden">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin: 15px 0;
                ">
                <strong>Status:</strong>
                <span id="statusBadge" class="status-badge"></span>
              </div>

              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin: 10px 0;
                ">
                <span
                  ><strong>Tipe Query:</strong> <span id="queryType"></span
                ></span>
                <span
                  ><strong>WHERE Clause:</strong> <span id="whereStatus"></span
                ></span>
              </div>

              <div id="errorsContainer" class="hidden">
                <h4 style="color: #dc2626; margin: 15px 0 10px 0">
                  ‚ùå Errors:
                </h4>
                <div id="errorsList"></div>
              </div>

              <div id="warningsContainer" class="hidden">
                <h4 style="color: #d97706; margin: 15px 0 10px 0">
                  ‚ö†Ô∏è Warnings:
                </h4>
                <div id="warningsList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Examples Section -->
      <div class="card">
        <h3>üß™ Contoh Query untuk Testing:</h3>

        <div class="example-card" data-query="UPDATE users SET name = 'John'">
          <strong>UPDATE tanpa WHERE</strong>
          <code>UPDATE users SET name = 'John'</code>
        </div>

        <div
          class="example-card"
          data-query="UPDATE users SET name = 'John' WHERE id = 1">
          <strong>UPDATE dengan WHERE</strong>
          <code>UPDATE users SET name = 'John' WHERE id = 1</code>
        </div>

        <div
          class="example-card"
          data-query="UPDATE users SET name = 'John' // where id = 1">
          <strong>WHERE dalam komentar (//)</strong>
          <code>UPDATE users SET name = 'John' // where id = 1</code>
        </div>

        <div
          class="example-card"
          data-query="UPDATE users SET name = 'John' -- where id = 1">
          <strong>WHERE dalam komentar (--)</strong>
          <code>UPDATE users SET name = 'John' -- where id = 1</code>
        </div>

        <div
          class="example-card"
          data-query="DELETE FROM users // where status = 'inactive'">
          <strong>DELETE dengan WHERE dikomen</strong>
          <code>DELETE FROM users // where status = 'inactive'</code>
        </div>
      </div>
    </div>
    <script>
      const API_BASE = "http://localhost:3000";

      // Initialize event listeners when page loads
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ SQL Validator Frontend Loaded");
        initializeApp();
      });

      function initializeApp() {
        console.log("üîß Initializing app...");

        // Check if essential elements exist
        const sqlQueryTextarea = document.getElementById("sqlQuery");
        const exampleCards = document.querySelectorAll(".example-card");
        const validationResult = document.getElementById("validationResult");

        console.log("üìã Found elements:", {
          textarea: !!sqlQueryTextarea,
          exampleCards: exampleCards.length,
          validationResult: !!validationResult,
        });

        // Add click events to example cards
        if (exampleCards.length > 0) {
          exampleCards.forEach((card) => {
            card.addEventListener("click", function () {
              const query = this.getAttribute("data-query");
              if (sqlQueryTextarea) {
                sqlQueryTextarea.value = query;
                showMessage("Contoh query dimuat!", "info");
              }
            });
          });
          console.log("‚úÖ Example cards initialized:", exampleCards.length);
        } else {
          console.warn("‚ùå No example cards found");
        }

        // Add event listener to textarea for Ctrl+Enter
        if (sqlQueryTextarea) {
          sqlQueryTextarea.addEventListener("keydown", function (e) {
            if (e.ctrlKey && e.key === "Enter") {
              validateQuery();
            }
          });
          console.log("‚úÖ Textarea event listener added");
        } else {
          console.error('‚ùå Textarea with id "sqlQuery" not found');
        }

        // Test API connection
        testAPI();
      }

      async function testAPI() {
        try {
          console.log("üîå Testing API connection...");
          const response = await fetch(`${API_BASE}/api/health`);
          if (response.ok) {
            const data = await response.json();
            console.log("‚úÖ API Connection: OK", data);
          } else {
            console.error("‚ùå API Connection: FAILED", response.status);
          }
        } catch (error) {
          console.error("‚ùå API Connection: ERROR", error);
        }
      }

      async function validateQuery() {
        const sqlQueryTextarea = document.getElementById("sqlQuery");
        if (!sqlQueryTextarea) {
          showMessage("Textarea tidak ditemukan!", "error");
          return;
        }

        const query = sqlQueryTextarea.value.trim();
        if (!query) {
          showMessage("Masukkan query SQL terlebih dahulu!", "error");
          return;
        }

        console.log(
          "üì® Sending validation request:",
          query.substring(0, 50) + "..."
        );

        try {
          const strictModeCheckbox = document.getElementById("strictMode");
          const strictMode = strictModeCheckbox
            ? strictModeCheckbox.checked
            : true;

          const response = await fetch(`${API_BASE}/api/validate`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              query,
              strictMode: strictMode,
            }),
          });

          console.log("üì© Response status:", response.status);

          // Check if response is JSON
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text();
            console.error(
              "‚ùå Server returned non-JSON response:",
              text.substring(0, 200)
            );
            throw new Error(
              "Server returned HTML instead of JSON. Check if server is running correctly."
            );
          }

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Terjadi kesalahan server");
          }

          console.log("‚úÖ Validation successful:", data);
          displayValidationResult(data);
        } catch (error) {
          console.error("‚ùå Validation error:", error);
          showMessage("Error: " + error.message, "error");
        }
      }

      async function autoFixQuery() {
        const sqlQueryTextarea = document.getElementById("sqlQuery");
        if (!sqlQueryTextarea) {
          showMessage("Textarea tidak ditemukan!", "error");
          return;
        }

        const query = sqlQueryTextarea.value.trim();
        if (!query) {
          showMessage("Masukkan query SQL terlebih dahulu!", "error");
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/api/auto-fix`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ query }),
          });

          // Check if response is JSON
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text();
            throw new Error("Server returned HTML instead of JSON");
          }

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Terjadi kesalahan");
          }

          // Update textarea dengan query yang sudah difix
          sqlQueryTextarea.value = data.fixedQuery;

          // Tampilkan hasil validasi
          displayValidationResult(data.validation);

          showMessage("Query berhasil diperbaiki!", "success");
        } catch (error) {
          console.error("Auto-fix error:", error);
          showMessage("Error: " + error.message, "error");
        }
      }

      function displayValidationResult(data) {
        console.log("üîÑ Displaying validation result:", data);

        const resultDiv = document.getElementById("validationResult");
        const statusBadge = document.getElementById("statusBadge");
        const queryType = document.getElementById("queryType");
        const whereStatus = document.getElementById("whereStatus");
        const errorsContainer = document.getElementById("errorsContainer");
        const warningsContainer = document.getElementById("warningsContainer");
        const errorsList = document.getElementById("errorsList");
        const warningsList = document.getElementById("warningsList");

        if (!resultDiv) return;

        // Show result container
        resultDiv.classList.remove("hidden");

        // Set status
        if (statusBadge) {
          if (data.isValid) {
            statusBadge.textContent = "VALID";
            statusBadge.className = "status-badge valid";
          } else {
            statusBadge.textContent = "INVALID";
            statusBadge.className = "status-badge invalid";
          }
        }

        // Tampilkan informasi query
        if (queryType) {
          if (data.queryCount > 1) {
            queryType.textContent = `${data.queryType} (${data.queryCount} queries - ${data.validQueryCount} valid, ${data.dangerousQueryCount} berbahaya)`;
          } else {
            queryType.textContent = data.queryType || "UNKNOWN";
          }
        }

        if (whereStatus) {
          whereStatus.textContent = `${data.queriesWithActiveWhere || 0}/${
            data.queryCount
          } queries memiliki WHERE aktif`;
        }

        // Display errors
        if (errorsList && errorsContainer) {
          errorsList.innerHTML = "";
          if (data.errors && data.errors.length > 0) {
            data.errors.forEach((error) => {
              const errorDiv = document.createElement("div");
              errorDiv.className = "error";
              errorDiv.textContent = error;
              errorsList.appendChild(errorDiv);
            });
            errorsContainer.classList.remove("hidden");
          } else {
            errorsContainer.classList.add("hidden");
          }
        }

        // Display warnings
        if (warningsList && warningsContainer) {
          warningsList.innerHTML = "";
          if (data.warnings && data.warnings.length > 0) {
            data.warnings.forEach((warning) => {
              const warningDiv = document.createElement("div");
              warningDiv.className = "warning";
              warningDiv.textContent = warning;
              warningsList.appendChild(warningDiv);
            });
            warningsContainer.classList.remove("hidden");
          } else {
            warningsContainer.classList.add("hidden");
          }
        }

        // Show message
        if (data.isValid) {
          showMessage(
            `‚úÖ ${data.validQueryCount}/${data.queryCount} query valid!`,
            "success"
          );
        } else {
          showMessage(
            `‚ùå ${data.dangerousQueryCount}/${data.queryCount} query berbahaya!`,
            "error"
          );
        }
      }

      function clearAll() {
        const sqlQueryTextarea = document.getElementById("sqlQuery");
        const resultDiv = document.getElementById("validationResult");

        if (sqlQueryTextarea) {
          sqlQueryTextarea.value = "";
        }
        if (resultDiv) {
          resultDiv.classList.add("hidden");
        }
        showMessage("Semua input dan hasil dihapus", "info");
      }

      function showMessage(message, type) {
        // Create a better message display
        const messageDiv = document.createElement("div");
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;

        const colors = {
          success: "#059669",
          error: "#dc2626",
          warning: "#d97706",
          info: "#2563eb",
        };

        messageDiv.style.background = colors[type] || colors.info;
        messageDiv.textContent = message;

        document.body.appendChild(messageDiv);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
          }
        }, 3000);

        // Add CSS animation
        const style = document.createElement("style");
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
      }
    </script>
  </body>
</html>
